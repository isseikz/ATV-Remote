# 設計コンセプト：ATV-Remote-KMP

KMP Android TV / Chromecast Remote Development Console


## 1. プロジェクト概要 📜

本プロジェクトは、Kotlin Multiplatform (KMP) を全面的に採用し、USB HDMIキャプチャデバイスから入力された Android TV デバイス（Chromecast を含む） の画面をリアルタイムでWebブラウザにストリーミングし、同時にADB経由でリモート操作することを可能にするフルスタックな開発コンソールを構築するものです。 利用環境をイントラネット（LAN/VPN）に限定し、映像伝送技術として WebRTC を採用することで、安定した超低遅延なリモート開発・デバッグ体験を実現します。


## 2. 目的とゴール 🎯

* プライマリゴール: イントラネット内のPCブラウザから、Android TV デバイスの画面をほぼ遅延なく確認し、開発やデバッグに必要なリモート操作を快適に実現する。
* テクニカルゴール: Ktorをバックエンド、Compose for Webをフロントエンドとして利用するKMPの能力を実証し、WebRTCを用いた高度なフルスタック開発の効率性と保守性の高さを示す。

### ユースケース:

* Android TVアプリ開発者が、実機デバッグを効率化する。
* QAエンジニアが、テストの自動化やリモートでの動作確認を行う。
* 別室にあるメディアデバイスを遠隔で操作する。


## 3. システムアーキテクチャ 🏗️
本システムは、クライアント、サーバー、Android TV デバイス、そしてHDMIキャプチャデバイスの4コンポーネントで構成されます。WebRTC通信確立のためのシグナリングにはWebSocketを、デバイス操作にはADBを利用します。

+---------------------------------+       +------------------------+
|      サーバー (Kotlin/Ktor)       |<---->| Chromecast / Android TV|
+---------------------------------+  ADB  +------------------------+
                ^ ▲                  ^                   | HDMI
                │ │ (シグナリング)     │ (映像入力)            ▼
     WebSocket  │ │                  ▼                 +-----------------+
                │ │              +-----------------+   | USB HDMI Capture|
                ▼ V              | Video4Linux/etc |<--+-----------------+
+-------------------------+       +-----------------+
| クライアント (Webブラウザ) |
+-------------------------+
▲                         │
│  (映像ストリーム P2P)     │
└-------------------------┘ (WebRTC)


### 映像フロー (WebRTC):

* Android TV デバイスのHDMI出力が、サーバーにUSB接続されたHDMIキャプチャデバイスに入力されます。
* サーバーは、OS標準のAPI（V4L2, DirectShow等）やFFmpegライブラリを通じてキャプチャデバイスを映像ソースとして認識し、ビデオストリームを取得します。
* クライアントがWebSocket経経由で接続すると、サーバーとクライアントはSDPやICE候補を交換し、WebRTCのP2P接続を確立します（シグナリング）。
* サーバーはキャプチャした映像ストリームをWebRTCのPeerConnectionを通じてクライアントに直接送信します。
* クライアントはブラウザネイティブの機能でWebRTCストリームを受信・デコードし、<video> 要素に描画します。

### 制御フロー (WebSocket):

* クライアントのUI操作は、シグナリング用のWebSocketを通じてサーバーに送信されます。
* サーバーは受信したコマンドを adb shell 等のコマンドとして実行し、ネットワーク経由でAndroid TV デバイスを操作します。

### アーキテクチャの選択理由 (通信技術の役割分担):

* 映像 (WebRTC): リアルタイムの映像ストリーミングでは、低遅延がユーザー体験の質を決定づけます。WebRTCのP2P通信は、このパフォーマンス最優先の要件を満たすための最適な技術です。
* 制御 & シグナリング (WebSocket): 制御コマンドやシグナリングメッセージは、確実な到達と順序性が重要です。また、発生頻度が低いため、ミリ秒単位の遅延差は体感に影響しません。WebRTCのシグナリングで既に確立しているWebSocket接続を制御にも流用することで、実装を大幅に簡素化しつつ、十分な応答性能と高い信頼性を確保します。この「適材適所」の思想が本システムの基本設計です。


## 4. 主要機能 ✨

### 超低遅延リアルタイムストリーミング:

* WebRTCを利用したH.264形式での画面キャプチャとP2P配信。
* 複数のクライアントが同時に同じ画面を閲覧可能。

### リモートADB制御:

* Web UIからのクリック操作で、定義済みのADBコマンド（ホーム、戻る等）を実行。
* （拡張機能として）任意のADBコマンドをテキスト入力で実行。

### フルスタックKotlin開発:

* サーバーサイド: Ktorフレームワークを使用し、シグナリングサーバーとADB連携プロセスを実装。
* クライアントサイド: Compose for Web (Kotlin/JS)を使用し、宣言的なUIとWebRTC接続管理を実装。
* コード共通化: 通信で利用するデータモデル等を commonMain で共有し、サーバー・クライアント間の型安全性を保証。


## 5. 技術スタック 🛠️

| カテゴリ       | 技術                         | 役割                                   |
|------------|----------------------------|--------------------------------------|
| 言語         | Kotlin                     | プロジェクト全体の開発言語                        |
| フレームワーク    | Kotlin Multiplatform (KMP) | サーバー/クライアント間のコード共通化基盤                |
| バックエンド     | Ktor                       | WebSocketシグナリングサーバー、Web UIのホスティング    |
| フロントエンド    | Kotlin/JS                  | ブラウザで動作するロジックの基盤                     |
| UIフレームワーク  | Compose for Web            | 宣言的なWeb UIの構築                        |
| 映像伝送       | WebRTC                     | ブラウザネイティブの超低遅延ストリーミング                |
| サーバーWebRTC | webrtc-kmp                 | KMPネイティブなWebRTCライブラリ                 |
| 映像キャプチャ    | webcam-capture (Sarxos)    | USBキャプチャデバイスからのシンプルな映像取得             |
| デバイス制御     | Android Debug Bridge (ADB) | Android TV / Chromecast へのリモートコマンド実行 |


## 6. 前提条件と制約 ⚠️

### 前提条件:

* **対象デバイス（Chromecast / Android TV）**で開発者向けオプションとネットワークデバッグが有効化されていること。
* サーバーマシンにADB環境が構築されており、対象デバイスにadb connectできるネットワーク環境であること。
* サーバーに互換性のあるUSB HDMIキャプチャデバイスが接続されていること。

### 制約事項:

* セキュリティ: イントラネット利用が前提ですが、システムへのアクセス制御は別途考慮が必要です。本システムはデバイスに強力な操作権限を与えます。
* 実装の複雑性: WebSocket単体方式に比べ、シグナリングサーバーの実装やP2P接続管理など、アーキテクチャが複雑化します。
* パフォーマンス: WebRTCへの移行により伝送遅延は大幅に改善されますが、USBキャプチャデバイスの性能やサーバーでのエンコード処理がボトルネックになる可能性があります。


## 7. 今後の展望 🚀

* 複数デバイス対応: 接続するデバイスをリストから選択・切り替えられるように機能を拡張する。
* デスクトップアプリ化: KMPの能力を活かし、同じロジックでWebクライアントだけでなく、デスクトップクライアント（Compose for Desktop）も提供する。
